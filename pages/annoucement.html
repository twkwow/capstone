<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/styles/admincontent.css">
    <link rel="stylesheet" href="/styles/components.css">
    <link rel="stylesheet" href="/styles/announcement.css">
    <link rel="stylesheet" href="/styles/verifications.css">
    <title>SecureHold</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="icon" href="/resources/images/logo.png" type="image/png">
    <script src="/components/sidebar.js" type="text/javascript" defer></script>
    <script src="/components/header.js" type="text/javascript" defer></script>
    <script src="/components/popupModal.js" type="text/javascript" defer></script>
    <script src="/components/snackbarNotification.js" type="text/javascript" defer></script>
</head>

<body style="display: flex;">
    <sidebar-component></sidebar-component>
    <div class="content-container">
        <header-component headerTitle="Annoucements"></header-component>

        <div class="body">
            <div class="content-split-left">
                <div class="content">
                    <span class="content-title">Add Announcements</span>
                    <form class="announcements-container" onsubmit="insertAnnoucement(event)">
        
                        <div class="add-ann-title">Title</div>
                        <div class="add-ann-content">
                            <textarea id="title" required class="announcements-textarea" rows="1" placeholder="Add your text"></textarea>
                        </div>
        
                        <div class="add-ann-title">Content</div>
                        <div class="add-ann-content">
                            <textarea id="content" required class="announcements-textarea" rows="10" placeholder="Add your text"></textarea>
                        </div>
        
                        <div class="add-ann-btn">
                            <input type="submit" id="add_ann" class="add-announcement-button" value="Add Announcement">
                        </div>
                    </form>
                </div>

                <div class="content">
                    <span class="content-title">Previous Annoucements</span>
                    <div id="prevAnnoucements"> <!-- Previous annoucements are here --> </div>
                </div>
            </div>
        </div>
    </div>

    <popupmodal-component modalId="ann-delete" modalClass="popup-container-ann-delete">
        <strong>Delete Annoucement</strong>
        <div class="ann-delete-text1">Permanently delete the annoucement? You can't undo this</div>
        <div class="pop-container">
            <button class="announcement-cancel-pop" onclick="showPopup('ann-delete', false)">Cancel</button>
            <button class="announcement-confirm-pop" onclick="showPopup('ann-delete', false); deleteAnnoucement()">Confirm</button>
        </div>
    </popupmodal-component>

    <snackbar-component snackbarId="insertAnnoucement">Annoucement Uploaded</snackbar-component>
    <snackbar-component snackbarId="deletedAnnoucement">Annoucement Deleted</snackbar-component>
</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
<script src="/app.js"></script>

<script>
    checkToken()

    var selectedAnnoucementId = ""

    function previousAnnoucementsHTML(_id, title, content, admin, time) {
        return `
        <div class="annoucement-card">
            <div class="annoucement-container">
                <div class="annoucement-container1">
                    <div class="annoucement-title">
                        <span>${title}</span>
                    </div>
                    <div class="annoucement-content">
                        <span> ${content} </span>
                    </div>
                </div>
                <div class="annoucement-container2">
                    <span>${admin}</span>
                </div>
                <div class="annoucement-container3">
                    <span>${time}</span>
                </div>
                <button class="annoucement-delete" onclick="selectedAnnoucementId = '${_id}'; showPopup('ann-delete', true)">Delete</button>
            </div>
        </div>
        `
    }

    async function getAnnoucements() {
        await axios.get(apiLink + "admins/annoucements/getAllAnnoucements")
        .then ( (res) => {
            //limit show up to 5 annoucements
            const approvalArr = res.data.data.slice(0,5)
            var innerHTML = ""
            approvalArr.forEach( (annoucement) => {
                innerHTML += previousAnnoucementsHTML(annoucement._id, annoucement.title, annoucement.content, annoucement.admin, moment(annoucement.timestamp).format('DD-MMM-YYYY h:mm:ss a'))
            })
            if (innerHTML) {
                document.getElementById("prevAnnoucements").innerHTML = innerHTML
            }
            else {
                document.getElementById("prevAnnoucements").innerHTML = `No annoucements posted`
            }
        })
        .catch((e) => {
            document.getElementById("prevAnnoucements").innerHTML = e

        })
    }
    getAnnoucements()

    async function insertAnnoucement() {
        event.preventDefault()

        const title = document.getElementById('title').value
        const content = document.getElementById('content').value
        const formattedTitle = title.replace(/\n/g, '<br>');
        const formattedContent = content.replace(/\n/g, '<br>');

        const annoucementForm = new FormData()
        annoucementForm.append("title", formattedTitle)
        annoucementForm.append("content", formattedContent)

        await axios.post(apiLink + 'admins/annoucements/insertAnnoucement', annoucementForm, { withCredentials: true})
        .then( () => {
            showSnackbar("insertAnnoucement")
            getAnnoucements()

        })
        .catch((e) => {
            console.log(e)
        } )
    }

    async function deleteAnnoucement() {

        const annoucementForm = new FormData()
        annoucementForm.append("_id", selectedAnnoucementId)

        await axios.post(apiLink + "admins/annoucements/deleteAnnoucement", annoucementForm )
        .then( (resp) => {
            if (resp.data.status == 200) {
                showSnackbar("deletedAnnoucement")
                getAnnoucements()
            }
        })
    }
</script>
