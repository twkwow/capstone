<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles.css">
    <link rel="stylesheet" href="/styles/verifications.css">
    <title>Reset Password</title>
    <link rel="icon" href="/resources/images/logo.png" type="image/png">
    <script src="/components/popupModal.js" type="text/javascript" defer></script>
</head>

<body class="verifications-container" onload="generateCaptcha()" onsubmit="resetPassword()">
    <header class="logo-container">
        <img src="/resources/images/securehold.png" alt="securehold">
    </header>
    
    <form class="form-container" onsubmit="handleRequest(event)">
        <h2>Forgot Password</h2>
        <input type="text" id="email" class="form-input" required placeholder="Email">
        <div class="send-code-container">
            <div style="display: flex; flex-direction: column; color:#007bff;">
                <input type="text" id="verifyCode" class="form-input" required placeholder="Verification Code">
                <div id="sendforgotcode" class="send-code" onclick="sendForgetCode()">Send Code</div>
            </div>
        </div>
        <input type="password" id="newpassword" class="form-input" required placeholder="New Password">
        <input type="password" id="newpasswordre" class="form-input" required placeholder="Re-type New Password">

        <div class="container1">
            <input type="text" id="captcha-input" name="captcha" required placeholder="Code">
            <div id="captcha-container" onclick="generateCaptcha()">
                <img id="captcha-img" alt="Captcha Image">
            </div>
        </div>
        <div id="alertText" class="alert-text"></div>

        <button type="submit" id="loginbutton" class="form-button">Reset</button>
        <div class="form-nav">
            Back to <a href="login.html">Log In</a>
        </div>
    </form>

    <footer class="footer-terms">
        <span onclick="showPopup('tos', true)">Terms of Services</span>
        &nbsp; | &nbsp;
        <span>Privacy Policy</span>
        &nbsp; | &nbsp;
         <span>Disclaimer</span>      	
    </footer>

    <popupmodal-component modalId="tos">            
        Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
    </popupmodal-component>
    <popupmodal-component modalId="codeSent">A code has been sent to your email !</popupmodal-component>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>
<script src="/app.js"></script>
<script src="/captcha.js"></script>

<script>
    function sendForgetCode() {
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const email = document.getElementById("email").value

        if (!emailPattern.test(email)) {
            return document.getElementById("alertText").innerHTML = "Please enter a valid email address"
        }
             
        const emailForm = new FormData()
        emailForm.append("email", email)
        axios.post(apiLink + "admins/sendForgetCode", emailForm)
        .then( (resp) => {
            return showPopup("codeSent", true)
        })
        .catch( (error) => {
            return console.log("API Error: " + error)
        })
    }

    function resetPassword() {
        event.preventDefault();
        
        const email = event.target.querySelector("#email").value;
        const password = event.target.querySelector("#newpassword").value;
        const passwordRe = event.target.querySelector("#newpasswordre").value;
        const code = event.target.querySelector("#verifyCode").value;

        //code if password don't match
        if (password != passwordRe) {
            return document.getElementById("alertText").innerHTML = "Passwords not matching"
        }

        const approvalRequest = new FormData()
        approvalRequest.append("email", email)
        approvalRequest.append("password", password)
        approvalRequest.append("code", code)

        axios.post(apiLink + "admins/resetPassword", approvalRequest)
        .then( (resp) => {
            console.log(resp)
            switch(resp.data.status) {
                case 200: console.log("done"); break;
                case 409: console.log("Email already in use"); break;
                case 401: console.log("Verification code not matching"); break;
                case 400: console.log("Please press send code to verify your email"); break;
            }
        })
        .catch( (error) => {
            console.log("API Error: " + error)
        })
    }
</script>